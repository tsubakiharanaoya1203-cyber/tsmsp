<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>月次売上</title>
  <style>
    :root{ --bg:#fff; --text:#111; --muted:#666; --border:#999; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:"Noto Sans JP", sans-serif;font-size:16px;}
    .main{padding:10px;max-width:980px;margin:0 auto;}
    .panel{border:2px solid var(--border);background:#fff;margin:8px 0;padding:8px;}
    .label{font-size:12px;color:var(--muted);margin:0 0 4px 0;}
    .input{width:100%;box-sizing:border-box;border:2px solid var(--border);padding:10px 8px;font-size:18px;background:#fff;color:inherit;}

    .tsms-header{position:sticky; top:0; z-index:100;height:60px; background:#fff;border-bottom:2px solid #000;display:flex; align-items:center;padding:0 14px 0 56px;font-weight:900; font-size:20px;}
    .header-to-report{margin-left:auto;border:2px solid #000;padding:6px 10px;font-size:14px;font-weight:900;color:#000;text-decoration:none;line-height:1.2;background:#fff;}
    .tsms-hamburger{position:absolute; left:14px; top:50%;transform:translateY(-50%);width:32px; height:24px;display:flex; flex-direction:column; justify-content:space-between;cursor:pointer; user-select:none;}
    .tsms-hamburger span{ height:3px; background:#000; display:block; }
    .tsms-menu{position:fixed; top:0; left:0; height:100%; width:280px;background:#fff; border-right:2px solid #000;transform:translateX(-100%);transition:transform .25s ease;z-index:1000; padding-top:60px;}
    .tsms-menu.open{ transform:translateX(0); }
    .tsms-menu a{display:block; padding:16px;border-bottom:1px solid #ddd;text-decoration:none; color:#000;font-size:18px; font-weight:900;}
    .tsms-menu small{ display:block; margin-top:2px; font-size:12px; font-weight:700; color:#666; }
    .tsms-menu-bg{position:fixed; inset:0;background:rgba(0,0,0,.25);opacity:0; pointer-events:none;transition:opacity .2s ease;z-index:900;}
    .tsms-menu-bg.show{ opacity:1; pointer-events:auto; }

    .table-wrap{border:2px solid var(--border);overflow:hidden;}
    table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:11px;}
    th,td{border:1px dashed var(--border);padding:4px 2px;text-align:center;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    th{background:var(--surface-2);font-weight:900;}
    td.date.sat{background:#e8f6ff;}
    td.date.sun{background:#ffecec;}
    .sum-row td{background:#55cad8;font-weight:900;border:2px solid var(--border);}

    .shift-btn{appearance:none;border:none;color:#fff;font-weight:900;border-radius:6px;padding:4px 2px;min-height:28px;width:100%;font-size:11px;}
    .s-work{background:#1c9b2d;}
    .s-holiday{background:#f0ad00;color:#1d1d1d;}
    .s-absence{background:#d64545;}
    .s-part{background:#187FBF;}

    .target-input{width:100%;box-sizing:border-box;border:1px solid var(--border);padding:3px 2px;font-size:11px;text-align:right;background:var(--surface-1);color:inherit;}
    td.muted, .muted .target-input{background:#e2e8ee !important;color:#6a7582 !important;}

    /* ---- Theme tokens ---- */
    :root{--bg:#F3F6F8;--surface-1:#FFFFFF;--surface-2:#EEF3F6;--border:#D5DEE6;--text-primary:#0F1720;--text-secondary:#344554;--text-muted:#5B6D7C;--accent:#2580ED;--accent-hover:#4DA3FF;--link:#187FBF;}
    :root[data-theme="dark"]{--bg:#0F1417;--surface-1:#151C20;--surface-2:#1B242A;--border:#2A353D;--text-primary:#E6EEF3;--text-secondary:#B7C4CC;--text-muted:#8A949A;--accent:#3B95F0;--accent-hover:#4DA3FF;--link:#58C2FF;}
    html,body{ background:var(--bg)!important; color:var(--text-primary)!important; }
    a{ color:var(--link); }
    .tsms-header,.header,.app-header,.card,.wf-panel,.section,.date-switcher,.menu,.tsms-menu,.box,.panel{background:var(--surface-1)!important;border-color:var(--border)!important;color:var(--text-primary)!important;}
    .note,.wf-field-label,.label,.k,.idx,.desc,.wf-subnote,.wf-field-label{color:var(--text-muted)!important;}
    .tsms-menu a,.menu a,.header-to-report,.btn,.actionBtn,.key,.input,select,.key.small{background:var(--surface-2)!important;color:var(--text-primary)!important;border-color:var(--border)!important;}
    .menu small,.tsms-menu small{color:var(--text-muted)!important;}
    .menu-bg,.tsms-menu-bg{background:rgba(15,23,32,.35)!important;}
    .hamburger span,.tsms-hamburger span{background:#58C2FF!important;}
    /* ---- Theme tokens end ---- */
  </style>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TSMS">
  <script>(function(){try{var t=localStorage.getItem("tsms_theme")==="dark"?"dark":"light";document.documentElement.setAttribute("data-theme",t);var m=document.querySelector('meta[name="theme-color"]');if(m)m.setAttribute("content",t==="dark"?"#0F1417":"#F3F6F8");}catch(e){}})();</script>
</head>
<body>
<nav class="tsms-menu" id="tsmsMenu" aria-label="サイドメニュー">
  <a href="index.html">TOP<small>メニュー一覧</small></a>
  <a href="report.html">日報入力<small>乗車データを入力</small></a>
  <a href="confirm.html">入力確認<small>当日・過去のデータを確認</small></a>
  <a href="detail.html">詳細確認<small>概算手取、集計結果など</small></a>
  <a href="ops.html">出庫 / 帰庫 / 休憩<small>休憩タイマーなど</small></a>
  <a href="sales.html">月次売上<small>当月、過去の売上確認</small></a>
  <a href="settings.html">設定<small>歩率、締め期間、シフトなど</small></a>
</nav>
<div class="tsms-menu-bg" id="tsmsMenuBg" aria-hidden="true"></div>

<header class="tsms-header">
  <div class="tsms-hamburger" id="tsmsHamburger" role="button" tabindex="0" aria-label="メニュー"><span></span><span></span><span></span></div>
  月次売上
  <a class="header-to-report" href="report.html">入力画面へ</a>
</header>

<main class="main">
  <section class="panel">
    <div class="label">表示月（締め期間）</div>
    <select class="input" id="monthSelect"></select>
  </section>

  <section class="table-wrap">
    <table>
      <thead>
      <tr>
        <th style="width:12%;">シフト</th>
        <th style="width:14%;">日付</th>
        <th style="width:12%;">目標</th>
        <th style="width:12%;">結果</th>
        <th style="width:12%;">対目標</th>
        <th style="width:10%;">出庫</th>
        <th style="width:12%;">実働</th>
        <th style="width:8%;">休憩</th>
        <th style="width:8%;">時給</th>
      </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
      <tr class="sum-row" id="sumRow">
        <td colspan="2">合計</td>
        <td id="sumTarget">0</td>
        <td id="sumResult">0</td>
        <td id="sumDiff">0</td>
        <td>-</td>
        <td id="sumWork">0:00</td>
        <td id="sumBreak">0:00</td>
        <td id="sumHour">0</td>
      </tr>
      </tfoot>
    </table>
  </section>
</main>

<script>
(function(){
  const REPORT_KEY='tsms_reports';
  const OPS_KEY='ops';
  const SETTINGS_KEY='tsms_settings';
  const PLAN_KEY='tsms_sales_plan';
  const SHIFT_ORDER=['work','holiday','absence','part'];
  const SHIFT_LABEL={work:'出勤',holiday:'休日',absence:'欠勤',part:'バイト'};
  const SHIFT_CLASS={work:'s-work',holiday:'s-holiday',absence:'s-absence',part:'s-part'};

  const defaults={taxRate:10,feeRate:4,goFeeYen:100,walkRate:50,closeStartDay:16,closeEndDay:15};

  const monthSelect=document.getElementById('monthSelect');
  const tbody=document.getElementById('tbody');

  function loadJson(k,f){try{const v=JSON.parse(localStorage.getItem(k)||'null');return v==null?f:v;}catch(_){return f;}}
  function saveJson(k,v){localStorage.setItem(k,JSON.stringify(v));}
  function ymd(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
  function parseYmd(s){const [y,m,d]=String(s).split('-').map(Number);return new Date(y,m-1,d);}  
  function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
  function addMonths(d,n){const x=new Date(d);x.setMonth(x.getMonth()+n);return x;}
  function fmtNum(v){return Math.round(Number(v)||0).toLocaleString('ja-JP');}
  function pad2(n){return String(n).padStart(2,'0');}
  function hm(totalMin){const m=Math.max(0,Math.round(Number(totalMin)||0));return `${Math.floor(m/60)}:${pad2(m%60)}`;}
  function dowJa(d){return ['日','月','火','水','木','金','土'][d.getDay()];}
  function minDiff(a,b){const x=new Date(a).getTime(), y=new Date(b).getTime(); if(isNaN(x)||isNaN(y)) return 0; return Math.max(0,Math.round((y-x)/60000));}

  function toDayId(r){
    if(r&&r.dayId) return String(r.dayId);
    const d=new Date(r?.createdAt||r?.at||Date.now());
    return isNaN(d)?'':ymd(d);
  }

  function getSettings(){ return Object.assign({}, defaults, loadJson(SETTINGS_KEY, {})); }

  function getPeriodForDate(date,startDay,endDay){
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    let start = new Date(d.getFullYear(), d.getMonth(), startDay);
    if(d.getDate() < startDay) start = addMonths(start,-1);
    let end = new Date(start.getFullYear(), start.getMonth(), endDay);
    if(end < start) end = addMonths(end,1);
    return {start,end};
  }

  function periodId(p){ return `${ymd(p.start)}_${ymd(p.end)}`; }
  function periodLabel(p){ return `${ymd(p.start)} 〜 ${ymd(p.end)}`; }

  function periodDays(p){
    const out=[]; let d=new Date(p.start);
    while(d<=p.end){ out.push(new Date(d)); d=addDays(d,1); }
    return out;
  }

  function calcDayNet(dayId, reports, settings){
    const rows=reports.filter(r=>toDayId(r)===dayId);
    if(!rows.length) return 0;
    let gross=0, feeBase=0, goFeeCases=0;
    rows.forEach(r=>{
      const cash=Number(r.cash)||0, credit=Number(r.credit)||0;
      gross += cash + credit;
      const pay=String(r.payMethod||'');
      if(['QR','クレカ','電子M','GO pay','GO Pay','乗込GO Pay'].includes(pay)) feeBase += cash + credit;
      const ride=String(r.rideType||'');
      if(ride==='GO' && !['GO pay','GO Pay','乗込GO Pay'].includes(pay)) goFeeCases += 1;
    });
    const tax = gross * (Number(settings.taxRate)||0) / 100;
    const fee = feeBase * (Number(settings.feeRate)||0) / 100;
    const goFee = goFeeCases * (Number(settings.goFeeYen)||0);
    const base = gross - tax - fee - goFee;
    return Math.round(base * (Number(settings.walkRate)||0) / 100);
  }

  function calcOpsDay(dayId){
    const ops=loadJson(OPS_KEY,{});
    if(!ops || ops.dayId!==dayId || !ops.returnAt) return null;
    const depart=ops.departAt?new Date(ops.departAt):null;
    const ret=ops.returnAt?new Date(ops.returnAt):null;
    const breakMin=(ops.breakSessions||[]).reduce((s,x)=>s+(Number(x.minutes)||0),0);
    const workMin=(depart&&ret)?Math.max(0,minDiff(depart,ret)-breakMin):0;
    return {
      depart: depart?`${pad2(depart.getHours())}:${pad2(depart.getMinutes())}`:'--',
      breakMin,
      workMin
    };
  }

  function getPlan(){ return loadJson(PLAN_KEY, {}); }
  function savePlan(p){ saveJson(PLAN_KEY, p); }

  function buildPeriods(settings,reports){
    const set = new Map();
    const seed=[new Date()];
    reports.forEach(r=>{ const d=parseYmd(toDayId(r)); if(!isNaN(d)) seed.push(d); });
    const ops=loadJson(OPS_KEY,{});
    if(ops && ops.dayId){ const d=parseYmd(ops.dayId); if(!isNaN(d)) seed.push(d); }
    seed.forEach(d=>{ const p=getPeriodForDate(d, Number(settings.closeStartDay)||16, Number(settings.closeEndDay)||15); set.set(periodId(p), p); });
    return Array.from(set.values()).sort((a,b)=>b.start-a.start);
  }

  function render(){
    const settings=getSettings();
    const reports=loadJson(REPORT_KEY,[]);
    const plan=getPlan();
    const periods=buildPeriods(settings,reports);

    if(!monthSelect.options.length){
      monthSelect.innerHTML=periods.map(p=>`<option value="${periodId(p)}">${periodLabel(p)}</option>`).join('');
    }
    if(!monthSelect.value && periods[0]) monthSelect.value=periodId(periods[0]);

    const period = periods.find(p=>periodId(p)===monthSelect.value) || periods[0];
    if(!period) return;
    const days=periodDays(period);

    tbody.innerHTML='';
    let sumTarget=0,sumResult=0,sumDiff=0,sumWork=0,sumBreak=0;

    days.forEach((d,idx)=>{
      const dayId=ymd(d);
      if(!plan[dayId]) plan[dayId]={ shift:'work', target:'' };

      // 1行だけデモデータ
      if(idx===0 && !plan[dayId]._demo){
        plan[dayId]={ shift:'work', target:'20000', _demo:true };
      }

      const row=plan[dayId];
      const shift=row.shift;
      const active=(shift==='work' || shift==='part');
      const result=active?calcDayNet(dayId,reports,settings):0;
      const target=active?(Number(row.target)||0):0;
      const diff=result-target;
      const opsData=active?calcOpsDay(dayId):null;
      const workMin=opsData?opsData.workMin:0;
      const breakMin=opsData?opsData.breakMin:0;
      const hour=workMin>0?Math.round(result/(workMin/60)):0;

      if(active){
        sumTarget+=target; sumResult+=result; sumDiff+=diff; sumWork+=workMin; sumBreak+=breakMin;
      }

      const tr=document.createElement('tr');
      const wk=d.getDay();
      const wkCls=wk===6?'sat':(wk===0?'sun':'');
      tr.innerHTML=`
        <td>
          <button type="button" class="shift-btn ${SHIFT_CLASS[shift]}" data-day="${dayId}">${SHIFT_LABEL[shift]}</button>
        </td>
        <td class="date ${wkCls}">${d.getMonth()+1}/${d.getDate()}(${dowJa(d)})</td>
        <td class="${active?'':'muted'}"><input class="target-input" data-target="${dayId}" value="${active?(row.target||''):''}" ${active?'':'disabled'} inputmode="numeric"></td>
        <td class="${active?'':'muted'}">${active?fmtNum(result):'-'}</td>
        <td class="${active?'':'muted'}">${active?(diff>=0?`+${fmtNum(diff)}`:`-${fmtNum(Math.abs(diff))}`):'-'}</td>
        <td class="${active?'':'muted'}">${active?(opsData?opsData.depart:'--'):'-'}</td>
        <td class="${active?'':'muted'}">${active?(opsData?hm(workMin):'--'):'-'}</td>
        <td class="${active?'':'muted'}">${active?(opsData?hm(breakMin):'--'):'-'}</td>
        <td class="${active?'':'muted'}">${active?(opsData?fmtNum(hour):'--'):'-'}</td>
      `;
      tbody.appendChild(tr);
    });

    savePlan(plan);

    document.getElementById('sumTarget').textContent=fmtNum(sumTarget);
    document.getElementById('sumResult').textContent=fmtNum(sumResult);
    document.getElementById('sumDiff').textContent=(sumDiff>=0?`+${fmtNum(sumDiff)}`:`-${fmtNum(Math.abs(sumDiff))}`);
    document.getElementById('sumWork').textContent=hm(sumWork);
    document.getElementById('sumBreak').textContent=hm(sumBreak);
    document.getElementById('sumHour').textContent=sumWork>0?fmtNum(Math.round(sumResult/(sumWork/60))):'0';
  }

  monthSelect.addEventListener('change', render);

  tbody.addEventListener('click',(e)=>{
    const btn=e.target.closest('.shift-btn');
    if(!btn) return;
    const day=btn.dataset.day;
    const plan=getPlan();
    if(!plan[day]) plan[day]={shift:'work',target:''};
    const i=SHIFT_ORDER.indexOf(plan[day].shift);
    plan[day].shift = SHIFT_ORDER[(i+1)%SHIFT_ORDER.length];
    savePlan(plan);
    render();
  });

  tbody.addEventListener('input',(e)=>{
    const input=e.target.closest('input[data-target]');
    if(!input) return;
    const day=input.dataset.target;
    const plan=getPlan();
    if(!plan[day]) plan[day]={shift:'work',target:''};
    plan[day].target = String(input.value||'').replace(/[^0-9]/g,'');
    savePlan(plan);
    render();
  });

  render();
})();
</script>

<script>
(function(){
  const menu = document.getElementById("tsmsMenu");
  const bg = document.getElementById("tsmsMenuBg");
  const burger = document.getElementById("tsmsHamburger");
  if(!menu || !bg || !burger) return;
  function openMenu(){ menu.classList.add("open"); bg.classList.add("show"); }
  function closeMenu(){ menu.classList.remove("open"); bg.classList.remove("show"); }
  burger.addEventListener("click", openMenu);
  burger.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" ") openMenu(); });
  bg.addEventListener("click", closeMenu);
  menu.querySelectorAll("a").forEach((a)=>a.addEventListener("click", closeMenu));
})();
</script>
<script>(function(){if('serviceWorker' in navigator && location.protocol.indexOf('http')===0){window.addEventListener('load', function(){navigator.serviceWorker.register('./sw.js').catch(function(){});});}})();</script>
</body>
</html>
