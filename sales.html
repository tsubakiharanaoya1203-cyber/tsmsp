<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æœˆé–“ç®¡ç†</title>
  <style>
    :root{ --bg:#fff; --text:#111; --muted:#666; --border:#999; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:"Noto Sans JP", sans-serif;font-size:16px;}
    .main{padding:10px;max-width:980px;margin:0 auto;}
    .panel{border:2px solid var(--border);background:#fff;margin:8px 0;padding:8px;}
    .label{font-size:12px;color:var(--muted);margin:0 0 4px 0;}
    .input{width:100%;box-sizing:border-box;border:2px solid var(--border);padding:10px 8px;font-size:18px;background:#fff;color:inherit;}

    .tsms-header{position:sticky; top:0; z-index:100;height:60px; background:#fff;border-bottom:2px solid #000;display:flex; align-items:center;padding:0 14px 0 56px;font-weight:900; font-size:20px;}
    .header-to-report{margin-left:auto;border:2px solid #000;padding:6px 10px;font-size:14px;font-weight:900;color:#000;text-decoration:none;line-height:1.2;background:#fff;}
    .tsms-hamburger{position:absolute; left:14px; top:50%;transform:translateY(-50%);width:32px; height:24px;display:flex; flex-direction:column; justify-content:space-between;cursor:pointer; user-select:none;}
    .tsms-hamburger span{ height:3px; background:#000; display:block; }
    .tsms-menu{position:fixed; top:0; left:0; height:100%; width:280px;background:#fff; border-right:2px solid #000;transform:translateX(-100%);transition:transform .25s ease;z-index:1000; padding-top:60px;}
    .tsms-menu.open{ transform:translateX(0); }
    .tsms-menu a{display:block; padding:16px;border-bottom:1px solid #ddd;text-decoration:none; color:#000;font-size:18px; font-weight:900;}
    .tsms-menu small{ display:block; margin-top:2px; font-size:12px; font-weight:700; color:#666; }
    .tsms-menu-bg{position:fixed; inset:0;background:rgba(0,0,0,.25);opacity:0; pointer-events:none;transition:opacity .2s ease;z-index:900;}
    .tsms-menu-bg.show{ opacity:1; pointer-events:auto; }

    .table-wrap{border:2px solid var(--border);overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;}
    table{width:max-content;min-width:610px;border-collapse:collapse;table-layout:fixed;font-size:11px;}
    th,td{border:1px dashed var(--border);padding:3px 2px;text-align:center;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    th{background:var(--surface-2);font-weight:900;}
    td.date.sat{background:var(--week-sat-bg);color:var(--weekend-text);font-weight:800;}
    td.date.sun{background:var(--week-sun-bg);color:var(--weekend-text);font-weight:800;}
    td.date.holiday{background:var(--week-sun-bg);color:var(--weekend-text);font-weight:800;}
    .sum-row td{background:#55cad8;font-weight:900;border:2px solid var(--border);}

    .shift-btn{appearance:none;border:none;color:#fff;font-weight:900;border-radius:6px;padding:4px 2px;min-height:28px;width:100%;font-size:11px;}
    .shift-btn:disabled{opacity:.55;filter:grayscale(.25);}
    .s-work{background:#1c9b2d;}
    .s-holiday{background:#f0ad00;color:#1d1d1d;}
    .s-absence{background:#d64545;}
    .s-part{background:#187FBF;}
    .s-furidashi{background:#1c9b2d;}
    .s-furikyu{background:#f0ad00;color:#1d1d1d;}

    .target-input{width:100%;box-sizing:border-box;border:1px solid var(--border);padding:3px 2px;font-size:11px;text-align:right;background:var(--surface-1);color:inherit;}
    td.muted, .muted .target-input{background:var(--disabled-bg) !important;color:var(--disabled-text) !important;}

    /* ---- Theme tokens ---- */
    :root{--bg:#F3F6F8;--surface-1:#FFFFFF;--surface-2:#EEF3F6;--border:#D5DEE6;--text-primary:#0F1720;--text-secondary:#344554;--text-muted:#5B6D7C;--accent:#2580ED;--accent-hover:#4DA3FF;--link:#187FBF;--week-sat-bg:#dff2ff;--week-sun-bg:#ffe2e2;--weekend-text:#1d2a35;--disabled-bg:#e2e8ee;--disabled-text:#6a7582;}
    :root[data-theme="dark"]{--bg:#0F1417;--surface-1:#151C20;--surface-2:#1B242A;--border:#2A353D;--text-primary:#E6EEF3;--text-secondary:#B7C4CC;--text-muted:#8A949A;--accent:#3B95F0;--accent-hover:#4DA3FF;--link:#58C2FF;--week-sat-bg:#25485e;--week-sun-bg:#5a2f37;--weekend-text:#f6fbff;--disabled-bg:#242d35;--disabled-text:#93a2af;}
    html,body{ background:var(--bg)!important; color:var(--text-primary)!important; }
    a{ color:var(--link); }
    .tsms-header,.header,.app-header,.card,.wf-panel,.section,.date-switcher,.menu,.tsms-menu,.box,.panel{background:var(--surface-1)!important;border-color:var(--border)!important;color:var(--text-primary)!important;}
    .note,.wf-field-label,.label,.k,.idx,.desc,.wf-subnote,.wf-field-label{color:var(--text-muted)!important;}
    .tsms-menu a,.menu a,.header-to-report,.btn,.actionBtn,.key,.input,select,.key.small{background:var(--surface-2)!important;color:var(--text-primary)!important;border-color:var(--border)!important;}
    .menu small,.tsms-menu small{color:var(--text-muted)!important;}
    .menu-bg,.tsms-menu-bg{background:rgba(15,23,32,.35)!important;}
    .hamburger span,.tsms-hamburger span{background:#58C2FF!important;}
    /* ---- Theme tokens end ---- */
  </style>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TSMS">
  <script>(function(){try{var t=localStorage.getItem("tsms_theme")==="dark"?"dark":"light";document.documentElement.setAttribute("data-theme",t);var m=document.querySelector('meta[name="theme-color"]');if(m)m.setAttribute("content",t==="dark"?"#0F1417":"#F3F6F8");}catch(e){}})();</script>

<style id="tsms-bottom-nav-style">
  body{padding-bottom:78px;}
  .tsms-hamburger,.hamburger,.tsms-menu,.menu,.tsms-menu-bg,.menu-bg{display:none!important;}
  .tsms-header,.header{padding-left:14px!important;}
  .tsms-header::before,.header::before{content:"";display:inline-block;width:22px;height:22px;flex:0 0 22px;margin-right:8px;background:url('icon.png') center/contain no-repeat;}
  .tsms-bottom-nav{position:fixed;left:0;right:0;bottom:0;z-index:1200;display:grid;grid-template-columns:repeat(5,1fr);background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);padding-bottom:env(safe-area-inset-bottom);}
  .tsms-bottom-nav a,.tsms-bottom-nav button{appearance:none;border:0;background:transparent;color:var(--text-secondary,#445);font:inherit;font-size:11px;font-weight:900;padding:8px 2px 9px;min-height:58px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;text-decoration:none;}
  .tsms-bottom-nav .ico{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;color:#58C2FF;}
  .tsms-bottom-nav .ico svg{width:22px;height:22px;stroke:#58C2FF;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;display:block;}
  .tsms-bottom-nav .active{color:var(--text-primary,#111);position:relative;}
  .tsms-bottom-nav .active::before{content:"";position:absolute;top:0;left:14%;right:14%;height:2px;background:#58C2FF;}
  .tsms-more-sheet{position:fixed;left:0;right:0;bottom:0;z-index:1300;background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);transform:translateY(110%);transition:transform .2s ease;padding:12px 12px calc(12px + env(safe-area-inset-bottom));}
  .tsms-more-sheet.show{transform:translateY(0);}
  .tsms-more-sheet a{display:block;padding:12px;border:2px solid var(--border,#ccc);margin-top:8px;text-decoration:none;color:var(--text-primary,#111);background:var(--surface-2,#f5f5f5);font-weight:900;}
  .tsms-more-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;z-index:1250;transition:opacity .2s;}
  .tsms-more-bg.show{opacity:1;pointer-events:auto;}
</style>

  <script type="module" src="auth-guard.js"></script>
</head>
<body>
<nav class="tsms-menu" id="tsmsMenu" aria-label="ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
  <a href="index.html">TOP<small>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§</small></a>
  <a href="report.html">æ—¥å ±å…¥åŠ›<small>ä¹—è»Šãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›</small></a>
  <a href="confirm.html">å…¥åŠ›ç¢ºèª<small>å½“æ—¥ãƒ»éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</small></a>
  <a href="detail.html">è©³ç´°ç¢ºèª<small>æ¦‚ç®—æ‰‹å–ã€é›†è¨ˆçµæœãªã©</small></a>
  <a href="ops.html">å‡ºåº« / å¸°åº« / ä¼‘æ†©<small>ä¼‘æ†©ã‚¿ã‚¤ãƒãƒ¼ãªã©</small></a>
  <a href="sales.html">æœˆé–“ç®¡ç†<small>å½“æœˆã€éå»ã®å£²ä¸Šç¢ºèª</small></a>
  <a href="settings.html">è¨­å®š<small>æ­©ç‡ã€ç· ã‚æœŸé–“ã€ã‚·ãƒ•ãƒˆãªã©</small></a>
</nav>
<div class="tsms-menu-bg" id="tsmsMenuBg" aria-hidden="true"></div>

<header class="tsms-header">
  <div class="tsms-hamburger" id="tsmsHamburger" role="button" tabindex="0" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼"><span></span><span></span><span></span></div>
  æœˆé–“ç®¡ç†
  <a class="header-to-report" href="report.html">å…¥åŠ›ç”»é¢ã¸</a>
</header>

<main class="main">
  <section class="panel">
    <div class="label">è¡¨ç¤ºæœˆï¼ˆç· ã‚æœŸé–“ï¼‰</div>
    <select class="input" id="monthSelect"></select>
  </section>

  <section class="table-wrap">
    <table>
      <thead>
      <tr>
        <th style="width:56px;">ã‚·ãƒ•ãƒˆ</th>
        <th style="width:78px;">æ—¥ä»˜</th>
        <th style="width:72px;">ç›®æ¨™</th>
        <th style="width:72px;">çµæœ</th>
        <th style="width:72px;">å¯¾ç›®æ¨™</th>
        <th style="width:60px;">å‡ºåº«</th>
        <th style="width:72px;">å®Ÿåƒ</th>
        <th style="width:56px;">ä¼‘æ†©</th>
        <th style="width:56px;">æ™‚çµ¦</th>
      </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
      <tr class="sum-row" id="sumRow">
        <td colspan="2">åˆè¨ˆ</td>
        <td id="sumTarget">0</td>
        <td id="sumResult">0</td>
        <td id="sumDiff">0</td>
        <td>-</td>
        <td id="sumWork">0:00</td>
        <td id="sumBreak">0:00</td>
        <td id="sumHour">0</td>
      </tr>
      </tfoot>
    </table>
  </section>
</main>

<script>
(function(){
  const REPORT_KEY='tsms_reports';
  const OPS_KEY='ops';
  const SETTINGS_KEY='tsms_settings';
  const PLAN_KEY='tsms_sales_plan';
  const HOLIDAY_KEY='tsms_holidays_jp_v1';
  const SHIFT_ORDER=['work','holiday','absence','part','furidashi','furikyu'];
  const SHIFT_LABEL={work:'å‡ºå‹¤',holiday:'ä¼‘æ—¥',absence:'æ¬ å‹¤',part:'ãƒã‚¤ãƒˆ',furidashi:'æŒ¯å‡º',furikyu:'æŒ¯ä¼‘'};
  const SHIFT_CLASS={work:'s-work',holiday:'s-holiday',absence:'s-absence',part:'s-part',furidashi:'s-furidashi',furikyu:'s-furikyu'};

  const defaults={taxRate:10,feeRate:4,goFeeYen:100,walkRate:50,closeStartDay:16,closeEndDay:15};

  const monthSelect=document.getElementById('monthSelect');
  const tbody=document.getElementById('tbody');

  function loadJson(k,f){try{const v=JSON.parse(localStorage.getItem(k)||'null');return v==null?f:v;}catch(_){return f;}}
  function saveJson(k,v){localStorage.setItem(k,JSON.stringify(v));}
  function ymd(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
  function parseYmd(s){const [y,m,d]=String(s).split('-').map(Number);return new Date(y,m-1,d);}  
  function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
  function addMonths(d,n){const x=new Date(d);x.setMonth(x.getMonth()+n);return x;}
  function fmtNum(v){return Math.round(Number(v)||0).toLocaleString('ja-JP');}
  function pad2(n){return String(n).padStart(2,'0');}
  function hm(totalMin){const m=Math.max(0,Math.round(Number(totalMin)||0));return `${Math.floor(m/60)}:${pad2(m%60)}`;}
  function dowJa(d){return ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];}
  function minDiff(a,b){const x=new Date(a).getTime(), y=new Date(b).getTime(); if(isNaN(x)||isNaN(y)) return 0; return Math.max(0,Math.round((y-x)/60000));}
  function todayYmd(){ const n=new Date(); return ymd(new Date(n.getFullYear(),n.getMonth(),n.getDate())); }

  async function loadHolidaySet(){
    try{
      const cached = loadJson(HOLIDAY_KEY, null);
      if(cached && typeof cached === 'object' && cached.map){
        const age = Date.now() - Number(cached.fetchedAt||0);
        if(age < 1000*60*60*24*7){
          return new Set(Object.keys(cached.map));
        }
      }
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 5000);
      const res = await fetch('https://holidays-jp.github.io/api/v1/date.json', {signal: ctrl.signal});
      clearTimeout(t);
      if(!res.ok) throw new Error('holiday fetch failed');
      const json = await res.json();
      saveJson(HOLIDAY_KEY, {fetchedAt:Date.now(), map:json});
      return new Set(Object.keys(json||{}));
    }catch(_){
      const fallback = loadJson(HOLIDAY_KEY, {map:{}});
      return new Set(Object.keys((fallback&&fallback.map)||{}));
    }
  }

  function toDayId(r){
    if(r&&r.dayId) return String(r.dayId);
    const d=new Date(r?.createdAt||r?.at||Date.now());
    return isNaN(d)?'':ymd(d);
  }

  function getSettings(){ return Object.assign({}, defaults, loadJson(SETTINGS_KEY, {})); }

  function getPeriodForDate(date,startDay,endDay){
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    let start = new Date(d.getFullYear(), d.getMonth(), startDay);
    if(d.getDate() < startDay) start = addMonths(start,-1);
    let end = new Date(start.getFullYear(), start.getMonth(), endDay);
    if(end < start) end = addMonths(end,1);
    return {start,end};
  }

  function periodId(p){ return `${ymd(p.start)}_${ymd(p.end)}`; }
  function periodLabel(p){ return `${ymd(p.start)} ã€œ ${ymd(p.end)}`; }

  function periodDays(p){
    const out=[]; let d=new Date(p.start);
    while(d<=p.end){ out.push(new Date(d)); d=addDays(d,1); }
    return out;
  }

  function calcDayNet(dayId, reports, settings){
    const rows=reports.filter(r=>toDayId(r)===dayId);
    if(!rows.length) return 0;
    let gross=0, feeBase=0, goFeeCases=0;
    rows.forEach(r=>{
      const cash=Number(r.cash)||0, credit=Number(r.credit)||0;
      gross += cash + credit;
      const pay=String(r.payMethod||'');
      if(['QR','ã‚¯ãƒ¬ã‚«','é›»å­M','GO pay','GO Pay','ä¹—è¾¼GO Pay'].includes(pay)) feeBase += cash + credit;
      const ride=String(r.rideType||'');
      if(ride==='GO' && !['GO pay','GO Pay','ä¹—è¾¼GO Pay'].includes(pay)) goFeeCases += 1;
    });
    const tax = gross * (Number(settings.taxRate)||0) / 100;
    const fee = feeBase * (Number(settings.feeRate)||0) / 100;
    const goFee = goFeeCases * (Number(settings.goFeeYen)||0);
    const base = gross - tax - fee - goFee;
    return Math.round(base * (Number(settings.walkRate)||0) / 100);
  }

  function calcOpsDay(dayId){
    const ops=loadJson(OPS_KEY,{});
    const opsDay = (ops && ops.dayId) ? String(ops.dayId) : String(localStorage.getItem('tsms_report_current_day')||'');
    if(!ops || opsDay!==dayId || !ops.returnAt) return null;
    const depart=ops.departAt?new Date(ops.departAt):null;
    const ret=ops.returnAt?new Date(ops.returnAt):null;
    const breakMin=(ops.breakSessions||[]).reduce((s,x)=>s+(Number(x.minutes)||0),0);
    const workMin=(depart&&ret)?Math.max(0,minDiff(depart,ret)-breakMin):0;
    return {
      depart: depart?`${pad2(depart.getHours())}:${pad2(depart.getMinutes())}`:'--',
      breakMin,
      workMin
    };
  }

  function getPlan(){ return loadJson(PLAN_KEY, {}); }
  function savePlan(p){ saveJson(PLAN_KEY, p); }

  function buildPeriods(settings,reports){
    const set = new Map();
    const seed=[new Date()];
    reports.forEach(r=>{ const d=parseYmd(toDayId(r)); if(!isNaN(d)) seed.push(d); });
    const ops=loadJson(OPS_KEY,{});
    if(ops && ops.dayId){ const d=parseYmd(ops.dayId); if(!isNaN(d)) seed.push(d); }

    // data-derived periods
    seed.forEach(d=>{ const p=getPeriodForDate(d, Number(settings.closeStartDay)||16, Number(settings.closeEndDay)||15); set.set(periodId(p), p); });

    // always include current + next 2 closing periods for planning
    const today = new Date();
    const base = getPeriodForDate(today, Number(settings.closeStartDay)||16, Number(settings.closeEndDay)||15);
    set.set(periodId(base), base);
    [1,2].forEach((m)=>{
      const shifted = addMonths(base.start, m);
      const future = getPeriodForDate(shifted, Number(settings.closeStartDay)||16, Number(settings.closeEndDay)||15);
      set.set(periodId(future), future);
    });

    const list = Array.from(set.values());
    const baseStartMs = base.start.getTime();
    list.sort((a,b)=>{
      const am = a.start.getTime();
      const bm = b.start.getTime();
      const aFuture = am >= baseStartMs;
      const bFuture = bm >= baseStartMs;
      if(aFuture && bFuture) return am - bm; // current -> next -> next2 ...
      if(aFuture !== bFuture) return aFuture ? -1 : 1; // future block first
      return bm - am; // past block: latest first
    });
    return list;
  }

  function render(holidaySet){
    const settings=getSettings();
    const reports=loadJson(REPORT_KEY,[]);
    const plan=getPlan();
    const periods=buildPeriods(settings,reports);

    if(!monthSelect.options.length){
      monthSelect.innerHTML=periods.map(p=>`<option value="${periodId(p)}">${periodLabel(p)}</option>`).join('');
    }
    if(!monthSelect.value && periods[0]) monthSelect.value=periodId(periods[0]);

    const period = periods.find(p=>periodId(p)===monthSelect.value) || periods[0];
    if(!period) return;
    const days=periodDays(period);
    const todayId = todayYmd();

    tbody.innerHTML='';
    let sumTarget=0,sumResult=0,sumDiff=0,sumWork=0,sumBreak=0;

    days.forEach((d,idx)=>{
      const dayId=ymd(d);
      if(!plan[dayId]) plan[dayId]={ shift:'work', target:'' };

      // 1è¡Œã ã‘ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿
      if(idx===0 && !plan[dayId]._demo){
        plan[dayId]={ shift:'work', target:'20000', _demo:true };
      }

      const row=plan[dayId];
      const shift=row.shift;
      const active=(shift==='work' || shift==='part' || shift==='furidashi');
      const pastLocked = dayId < todayId;
      const result=active?calcDayNet(dayId,reports,settings):0;
      const target=active?(Number(row.target)||0):0;
      const diff=result-target;
      const opsData=active?calcOpsDay(dayId):null;
      const workMin=opsData?opsData.workMin:0;
      const breakMin=opsData?opsData.breakMin:0;
      const hour=workMin>0?Math.round(result/(workMin/60)):0;

      if(active){
        sumTarget+=target; sumResult+=result; sumDiff+=diff; sumWork+=workMin; sumBreak+=breakMin;
      }

      const tr=document.createElement('tr');
      const wk=d.getDay();
      const isHoliday = holidaySet && holidaySet.has(dayId);
      const wkCls=wk===6?'sat':((wk===0||isHoliday)?'sun holiday':'');
      tr.innerHTML=`
        <td>
          <button type="button" class="shift-btn ${SHIFT_CLASS[shift]}" data-day="${dayId}" ${pastLocked?'disabled':''}>${SHIFT_LABEL[shift]}</button>
        </td>
        <td class="date ${wkCls}">${d.getMonth()+1}/${d.getDate()}(${dowJa(d)})</td>
        <td class="${(active && !pastLocked)?'':'muted'}"><input class="target-input" data-target="${dayId}" value="${(active && !pastLocked)?(row.target||''):''}" ${(active && !pastLocked)?'':'disabled'} inputmode="numeric"></td>
        <td class="${active?'':'muted'}">${active?fmtNum(result):'-'}</td>
        <td class="${active?'':'muted'}">${active?(diff>=0?`+${fmtNum(diff)}`:`-${fmtNum(Math.abs(diff))}`):'-'}</td>
        <td class="${active?'':'muted'}">${active?(opsData?opsData.depart:'--'):'-'}</td>
        <td class="${active?'':'muted'}">${active?(opsData?hm(workMin):'--'):'-'}</td>
        <td class="${active?'':'muted'}">${active?(opsData?hm(breakMin):'--'):'-'}</td>
        <td class="${active?'':'muted'}">${active?(opsData?fmtNum(hour):'--'):'-'}</td>
      `;
      tbody.appendChild(tr);
    });

    savePlan(plan);

    document.getElementById('sumTarget').textContent=fmtNum(sumTarget);
    document.getElementById('sumResult').textContent=fmtNum(sumResult);
    document.getElementById('sumDiff').textContent=(sumDiff>=0?`+${fmtNum(sumDiff)}`:`-${fmtNum(Math.abs(sumDiff))}`);
    document.getElementById('sumWork').textContent=hm(sumWork);
    document.getElementById('sumBreak').textContent=hm(sumBreak);
    document.getElementById('sumHour').textContent=sumWork>0?fmtNum(Math.round(sumResult/(sumWork/60))):'0';
  }

  let holidaySet = new Set();
  monthSelect.addEventListener('change', ()=>render(holidaySet));

  tbody.addEventListener('click',(e)=>{
    const btn=e.target.closest('.shift-btn');
    if(!btn) return;
    const day=btn.dataset.day;
    const plan=getPlan();
    if(!plan[day]) plan[day]={shift:'work',target:''};
    const i=SHIFT_ORDER.indexOf(plan[day].shift);
    plan[day].shift = SHIFT_ORDER[(i+1)%SHIFT_ORDER.length];
    savePlan(plan);
    render(holidaySet);
  });

  tbody.addEventListener('input',(e)=>{
    const input=e.target.closest('input[data-target]');
    if(!input) return;
    const day=input.dataset.target;
    const plan=getPlan();
    if(!plan[day]) plan[day]={shift:'work',target:''};
    plan[day].target = String(input.value||'').replace(/[^0-9]/g,'');
    savePlan(plan);
  });

  tbody.addEventListener('change',(e)=>{
    const input=e.target.closest('input[data-target]');
    if(!input) return;
    render(holidaySet);
  });

  (async function init(){
    holidaySet = await loadHolidaySet();
    render(holidaySet);
  })();
})();
</script>

<script>
(function(){
  const menu = document.getElementById("tsmsMenu");
  const bg = document.getElementById("tsmsMenuBg");
  const burger = document.getElementById("tsmsHamburger");
  if(!menu || !bg || !burger) return;
  function openMenu(){ menu.classList.add("open"); bg.classList.add("show"); }
  function closeMenu(){ menu.classList.remove("open"); bg.classList.remove("show"); }
  burger.addEventListener("click", openMenu);
  burger.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" ") openMenu(); });
  bg.addEventListener("click", closeMenu);
  menu.querySelectorAll("a").forEach((a)=>a.addEventListener("click", closeMenu));
})();
</script>
<script>(function(){if('serviceWorker' in navigator && location.protocol.indexOf('http')===0){window.addEventListener('load', function(){navigator.serviceWorker.register('./sw.js').catch(function(){});});}})();</script>

<nav class="tsms-bottom-nav" aria-label="ãƒœãƒˆãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
  <a href="report.html" data-tab="report"><span class="ico">ğŸ“</span><span>æ—¥å ±å…¥åŠ›</span></a>
  <a href="confirm.html" data-tab="confirm"><span class="ico">âœ…</span><span>å…¥åŠ›ç¢ºèª</span></a>
  <a href="detail.html" data-tab="detail"><span class="ico">ğŸ“Š</span><span>è©³ç´°ç¢ºèª</span></a>
  <a href="ops.html" data-tab="ops"><span class="ico">ğŸš•</span><span>å‡ºåº«/å¸°åº«</span></a>
  <button type="button" id="tsmsMoreBtn"><span class="ico">â‹¯</span><span>ãã®ä»–</span></button>
</nav>
<div class="tsms-more-bg" id="tsmsMoreBg"></div>
<div class="tsms-more-sheet" id="tsmsMoreSheet" aria-label="ãã®ä»–ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
  <a href="index.html">TOP</a>
  <a href="sales.html">æœˆé–“ç®¡ç†</a>
  <a href="settings.html">è¨­å®š</a>
</div>
<script>
(function(){
  var page=(location.pathname.split('/').pop()||'index.html').replace('.html','');
  document.querySelectorAll('.tsms-bottom-nav [data-tab]').forEach(function(a){
    if(a.getAttribute('data-tab')===page) a.classList.add('active');
  });
  var iconMap={
    report:'<svg viewBox="0 0 24 24"><rect x="4" y="3" width="16" height="18" rx="2"/><path d="M8 8h8M8 12h8M8 16h5"/></svg>',
    confirm:'<svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="m8 12 3 3 5-6"/></svg>',
    detail:'<svg viewBox="0 0 24 24"><path d="M4 19h16"/><rect x="6" y="10" width="3" height="6"/><rect x="11" y="7" width="3" height="9"/><rect x="16" y="5" width="3" height="11"/></svg>',
    ops:'<svg viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="8" rx="2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M6 8l2-3h8l2 3"/></svg>',
    more:'<svg viewBox="0 0 24 24"><circle cx="6" cy="7" r="1.5"/><circle cx="6" cy="12" r="1.5"/><circle cx="6" cy="17" r="1.5"/><path d="M10 7h10M10 12h10M10 17h10"/></svg>'
  };
  document.querySelectorAll('.tsms-bottom-nav [data-tab]').forEach(function(a){
    var k=a.getAttribute('data-tab');
    var ico=a.querySelector('.ico');
    if(ico && iconMap[k]) ico.innerHTML=iconMap[k];
  });
  var moreIco=document.querySelector('#tsmsMoreBtn .ico');
  if(moreIco) moreIco.innerHTML=iconMap.more;
  var btn=document.getElementById('tsmsMoreBtn');
  var bg=document.getElementById('tsmsMoreBg');
  var sheet=document.getElementById('tsmsMoreSheet');
  function closeMore(){sheet.classList.remove('show');bg.classList.remove('show');}
  if(btn&&bg&&sheet){
    btn.addEventListener('click',function(){sheet.classList.add('show');bg.classList.add('show');});
    bg.addEventListener('click',closeMore);
  }
  var guard = page==='report';
  function isDirtyReport(){
    var cash=document.getElementById('in_cash');
    var credit=document.getElementById('in_credit');
    var note=document.getElementById('in_note');
    var hasVal=((cash&&cash.value)||(credit&&credit.value)||(note&&note.value));
    var selected=document.querySelector('button[data-group].is-selected');
    return !!(hasVal||selected);
  }
  document.querySelectorAll('.tsms-bottom-nav a, .tsms-more-sheet a').forEach(function(a){
    a.addEventListener('click',function(e){
      if(guard && isDirtyReport() && !confirm('å…¥åŠ›ã‚’ä¸­æ­¢ã—ã¾ã™ã‹ï¼Ÿ')){
        e.preventDefault();
      }
      closeMore();
    });
  });
})();
</script>

</body>
</html>
