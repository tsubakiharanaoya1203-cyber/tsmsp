<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å…¥åŠ›ç¢ºèª</title>
<style>
  body{margin:0;font-family:"Noto Sans JP", sans-serif;background:#fff;color:#000}
  .wrap{max-width:480px;margin:0 auto;padding:16px}
  .card{border:2px solid #000;padding:12px;margin-bottom:12px}
  .row{display:flex;justify-content:space-between;margin:4px 0;padding-bottom:2px}
  .row.underline-dashed{border-bottom:1px dashed var(--border);}
  .label{font-weight:900}
  .note{margin-top:6px;font-size:14px}
  .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .actionBtn{border:2px solid #000;background:#fff;padding:6px 10px;font-weight:900;font-size:14px}
  .empty{padding:24px 0;color:#666;text-align:center}
  .date-switcher{border:2px solid #000;padding:10px;margin:0 0 12px 0}
  .date-switcher label{display:block;font-size:13px;color:#666;margin-bottom:6px}
  .date-switcher select{width:100%;box-sizing:border-box;border:2px solid #000;background:#fff;padding:10px;font-size:16px}
  .tsms-header{
    position:sticky; top:0; z-index:100;
    height:60px; background:#fff;
    border-bottom:2px solid #000;
    display:flex; align-items:center;
    padding:0 14px 0 56px;
    font-weight:900; font-size:20px;
  }
  .header-to-report{
    margin-left:auto;
    border:2px solid #000;
    padding:6px 10px;
    font-size:14px;
    font-weight:900;
    color:#000;
    text-decoration:none;
    line-height:1.2;
    background:#fff;
  }
  .tsms-hamburger{
    position:absolute; left:14px; top:50%;
    transform:translateY(-50%);
    width:32px; height:24px;
    display:flex; flex-direction:column; justify-content:space-between;
    cursor:pointer; user-select:none;
  }
  .tsms-hamburger span{ height:3px; background:#000; display:block; }
  .tsms-menu{
    position:fixed; top:0; left:0; height:100%; width:280px;
    background:#fff; border-right:2px solid #000;
    transform:translateX(-100%);
    transition:transform .25s ease;
    z-index:1000; padding-top:60px;
  }
  .tsms-menu.open{ transform:translateX(0); }
  .tsms-menu a{
    display:block; padding:16px;
    border-bottom:1px solid #ddd;
    text-decoration:none; color:#000;
    font-size:18px; font-weight:900;
  }
  .tsms-menu small{ display:block; margin-top:2px; font-size:12px; font-weight:700; color:#666; }
  .tsms-menu-bg{
    position:fixed; inset:0;
    background:rgba(0,0,0,.25);
    opacity:0; pointer-events:none;
    transition:opacity .2s ease;
    z-index:900;
  }
  .tsms-menu-bg.show{ opacity:1; pointer-events:auto; }
  /* ---- Theme tokens ---- */
:root{
  --bg:#F3F6F8;
  --surface-1:#FFFFFF;
  --surface-2:#EEF3F6;
  --border:#D5DEE6;
  --text-primary:#0F1720;
  --text-secondary:#344554;
  --text-muted:#5B6D7C;
  --accent:#2580ED;
  --accent-hover:#4DA3FF;
  --link:#187FBF;
}
:root[data-theme="dark"]{
  --bg:#0F1417;
  --surface-1:#151C20;
  --surface-2:#1B242A;
  --border:#2A353D;
  --text-primary:#E6EEF3;
  --text-secondary:#B7C4CC;
  --text-muted:#8A949A;
  --accent:#3B95F0;
  --accent-hover:#4DA3FF;
  --link:#58C2FF;
}
html,body{ background:var(--bg)!important; color:var(--text-primary)!important; }
a{ color:var(--link); }
.tsms-header,.header,.app-header,.card,.wf-panel,.section,.date-switcher,.menu,.tsms-menu,.box{background:var(--surface-1)!important;border-color:var(--border)!important;color:var(--text-primary)!important;}
.note,.wf-field-label,.label,.k,.idx,.desc,.wf-subnote,.wf-field-label{color:var(--text-muted)!important;}
.tsms-menu a,.menu a,.header-to-report,.btn,.actionBtn,.key,.input,select,.key.small{background:var(--surface-2)!important;color:var(--text-primary)!important;border-color:var(--border)!important;}
.menu small,.tsms-menu small{color:var(--text-muted)!important;}
.btn.next{background:var(--accent)!important;border-color:var(--accent)!important;color:#fff!important;}
.menu-bg,.tsms-menu-bg{background:rgba(15,23,32,.35)!important;}

.hamburger span,.tsms-hamburger span{background:#58C2FF!important;}
/* ---- Theme tokens end ---- */

</style>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TSMS">

  <script>(function(){try{var t=localStorage.getItem("tsms_theme")==="dark"?"dark":"light";document.documentElement.setAttribute("data-theme",t);var m=document.querySelector('meta[name="theme-color"]');if(m)m.setAttribute("content",t==="dark"?"#0F1417":"#F3F6F8");}catch(e){}})();</script>

<style id="tsms-bottom-nav-style">
  body{padding-bottom:78px;}
  .tsms-hamburger,.hamburger,.tsms-menu,.menu,.tsms-menu-bg,.menu-bg{display:none!important;}
  .tsms-header,.header{padding-left:14px!important;}
  .tsms-bottom-nav{position:fixed;left:0;right:0;bottom:0;z-index:1200;display:grid;grid-template-columns:repeat(5,1fr);background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);padding-bottom:env(safe-area-inset-bottom);}
  .tsms-bottom-nav a,.tsms-bottom-nav button{appearance:none;border:0;background:transparent;color:var(--text-secondary,#445);font:inherit;font-size:11px;font-weight:900;padding:8px 2px 9px;min-height:58px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;text-decoration:none;}
  .tsms-bottom-nav .ico{font-size:16px;line-height:1;color:#58C2FF;}
  .tsms-bottom-nav .active{color:var(--text-primary,#111);position:relative;}
  .tsms-bottom-nav .active::before{content:"";position:absolute;top:0;left:14%;right:14%;height:2px;background:#58C2FF;}
  .tsms-more-sheet{position:fixed;left:0;right:0;bottom:0;z-index:1300;background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);transform:translateY(110%);transition:transform .2s ease;padding:12px 12px calc(12px + env(safe-area-inset-bottom));}
  .tsms-more-sheet.show{transform:translateY(0);}
  .tsms-more-sheet a{display:block;padding:12px;border:2px solid var(--border,#ccc);margin-top:8px;text-decoration:none;color:var(--text-primary,#111);background:var(--surface-2,#f5f5f5);font-weight:900;}
  .tsms-more-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;z-index:1250;transition:opacity .2s;}
  .tsms-more-bg.show{opacity:1;pointer-events:auto;}
</style>

</head>
<body>
<div class="wrap">
<nav class="tsms-menu" id="tsmsMenu" aria-label="ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
  <a href="index.html">TOP<small>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§</small></a>
  <a href="report.html">æ—¥å ±å…¥åŠ›<small>ä¹—è»Šãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›</small></a>
  <a href="confirm.html">å…¥åŠ›ç¢ºèª<small>å½“æ—¥ãƒ»éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</small></a>
  <a href="detail.html">è©³ç´°ç¢ºèª<small>æ¦‚ç®—æ‰‹å–ã€é›†è¨ˆçµæœãªã©</small></a>
  <a href="ops.html">å‡ºåº« / å¸°åº« / ä¼‘æ†©<small>ä¼‘æ†©ã‚¿ã‚¤ãƒãƒ¼ãªã©</small></a>
  <a href="sales.html">æœˆæ¬¡å£²ä¸Š<small>å½“æœˆã€éå»ã®å£²ä¸Šç¢ºèª</small></a>
  <a href="settings.html">è¨­å®š<small>æ­©ç‡ã€ç· ã‚æœŸé–“ã€ã‚·ãƒ•ãƒˆãªã©</small></a>
</nav>
<div class="tsms-menu-bg" id="tsmsMenuBg" aria-hidden="true"></div>
<header class="tsms-header">
  <div class="tsms-hamburger" id="tsmsHamburger" role="button" tabindex="0" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
    <span></span><span></span><span></span>
  </div>
  å…¥åŠ›ç¢ºèª
  <a class="header-to-report" href="report.html">å…¥åŠ›ç”»é¢ã¸</a>
</header>

<section class="date-switcher">
  <label for="confirmDateSelect">è¡¨ç¤ºæ—¥ä»˜</label>
  <select id="confirmDateSelect" aria-label="è¡¨ç¤ºæ—¥ä»˜"></select>
</section>
<div id="cards"></div>
</div>

<script>
(function(){
  const KEY = "tsms_reports";
  const CURRENT_DAY_KEY = "tsms_report_current_day";
  let allData = [];
  let selectedDayId = "";

  function yen(v){
    const n = Number(v || 0);
    return n.toLocaleString("ja-JP") + "å††";
  }
  function esc(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function save(){
    localStorage.setItem(KEY, JSON.stringify(allData));
  }

  function load(){
    try { allData = JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch (_) { allData = []; }
    if(!Array.isArray(allData)) allData = [];
  }

  function fallbackDayIdFromTs(ts){
    if(!ts) return "";
    const d = new Date(ts);
    if(isNaN(d)) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function rowDayId(r){
    return (r && r.dayId) ? String(r.dayId) : fallbackDayIdFromTs(r && r.ts);
  }

  function dayLabel(dayId){
    return String(dayId || "").replace(/-/g, "/");
  }

  function availableDays(){
    const set = new Set();
    allData.forEach((r)=>{
      const dayId = rowDayId(r);
      if(dayId) set.add(dayId);
    });
    return Array.from(set).sort((a,b)=> b.localeCompare(a));
  }

  function syncDateSelect(){
    const sel = document.getElementById("confirmDateSelect");
    if(!sel) return;
    const days = availableDays();
    sel.innerHTML = "";

    if(!days.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãªã—";
      sel.appendChild(opt);
      sel.disabled = true;
      selectedDayId = "";
      return;
    }

    days.forEach((dayId)=>{
      const opt = document.createElement("option");
      opt.value = dayId;
      opt.textContent = dayLabel(dayId);
      sel.appendChild(opt);
    });

    const currentDay = localStorage.getItem(CURRENT_DAY_KEY) || "";
    const picked = [selectedDayId, currentDay, days[0]].find((v)=> v && days.includes(v)) || days[0];
    selectedDayId = picked;
    sel.value = picked;
    sel.disabled = false;
  }

  function filteredDataWithIndex(){
    const out = [];
    allData.forEach((r, idx)=>{
      if(rowDayId(r) === selectedDayId){
        out.push({ row: r, idx });
      }
    });
    return out;
  }

  function render(){
    const root = document.getElementById("cards");
    if(!root) return;

    const rows = filteredDataWithIndex();
    if(rows.length === 0){
      root.innerHTML = '<div class="empty">ã“ã®æ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    root.innerHTML = "";
    rows.forEach(({row:r, idx})=>{
      const card = document.createElement("div");
      card.className = "card";
      const lines = [];
      lines.push(`<div class="row"><span class="label">æ™‚é–“</span><span>${esc(r.time||"")}</span></div>`);
      lines.push(`<div class="row"><span class="label">ä¹—è»Šç¨®åˆ¥</span><span>${esc(r.rideType||"")}</span></div>`);
      lines.push(`<div class="row underline-dashed"><span class="label">æ”¯æ‰•ã„æ–¹æ³•</span><span>${esc(r.payMethod||"")}</span></div>`);
      if(r.ticketSub) lines.push(`<div class="row"><span class="label">ãƒã‚±ãƒƒãƒˆåŒºåˆ†</span><span>${esc(r.ticketSub)}</span></div>`);
      if(Number(r.cash||0) > 0) lines.push(`<div class="row"><span class="label">ç¾å</span><span>${esc(yen(r.cash))}</span></div>`);
      if(Number(r.credit||0) > 0) lines.push(`<div class="row"><span class="label">æœªå</span><span>${esc(yen(r.credit))}</span></div>`);
      if(r.note) lines.push(`<div class="note">${esc(r.note)}</div>`);

      card.innerHTML = lines.join("\n") + `
        <div class="actions">
          <button type="button" class="actionBtn" data-action="edit" data-idx="${idx}">ä¿®æ­£</button>
          <button type="button" class="actionBtn" data-action="delete" data-idx="${idx}">å‰Šé™¤</button>
        </div>`;
      root.appendChild(card);
    });
  }

  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("button.actionBtn");
    if(!btn) return;

    const action = btn.dataset.action;
    const idx = Number(btn.dataset.idx);
    if(Number.isNaN(idx) || !allData[idx]) return;

    if(action === "delete"){
      if(!confirm("å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      allData.splice(idx, 1);
      save();
      syncDateSelect();
      render();
      return;
    }

    if(action === "edit"){
      const id = allData[idx].id;
      if(!id){
        alert("ç·¨é›†å¯¾è±¡ã®IDãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      location.href = `report.html?edit=${encodeURIComponent(id)}`;
    }
  });

  const sel = document.getElementById("confirmDateSelect");
  if(sel){
    sel.addEventListener("change", ()=>{
      selectedDayId = sel.value || "";
      render();
    });
  }

  load();
  syncDateSelect();
  render();
})();
</script>

<script>
(function(){
  const menu = document.getElementById("tsmsMenu");
  const bg = document.getElementById("tsmsMenuBg");
  const burger = document.getElementById("tsmsHamburger");
  if(!menu || !bg || !burger) return;

  function openMenu(){ menu.classList.add("open"); bg.classList.add("show"); }
  function closeMenu(){ menu.classList.remove("open"); bg.classList.remove("show"); }

  burger.addEventListener("click", openMenu);
  burger.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" ") openMenu(); });
  bg.addEventListener("click", closeMenu);
  menu.querySelectorAll("a").forEach((a)=>a.addEventListener("click", closeMenu));
})();
</script>

<script>
  (function(){if('serviceWorker'in navigator&&location.protocol.indexOf('http')===0){window.addEventListener('load',function(){navigator.serviceWorker.register('./sw.js').catch(function(){});});}})();
</script>


<nav class="tsms-bottom-nav" aria-label="ãƒœãƒˆãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
  <a href="report.html" data-tab="report"><span class="ico">ğŸ“</span><span>æ—¥å ±å…¥åŠ›</span></a>
  <a href="confirm.html" data-tab="confirm"><span class="ico">âœ…</span><span>å…¥åŠ›ç¢ºèª</span></a>
  <a href="detail.html" data-tab="detail"><span class="ico">ğŸ“Š</span><span>è©³ç´°ç¢ºèª</span></a>
  <a href="ops.html" data-tab="ops"><span class="ico">ğŸš•</span><span>å‡ºåº«/å¸°åº«</span></a>
  <button type="button" id="tsmsMoreBtn"><span class="ico">â‹¯</span><span>ãã®ä»–</span></button>
</nav>
<div class="tsms-more-bg" id="tsmsMoreBg"></div>
<div class="tsms-more-sheet" id="tsmsMoreSheet" aria-label="ãã®ä»–ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
  <a href="index.html">TOP</a>
  <a href="sales.html">æœˆæ¬¡å£²ä¸Š</a>
  <a href="settings.html">è¨­å®š</a>
</div>
<script>
(function(){
  var page=(location.pathname.split('/').pop()||'index.html').replace('.html','');
  document.querySelectorAll('.tsms-bottom-nav [data-tab]').forEach(function(a){
    if(a.getAttribute('data-tab')===page) a.classList.add('active');
  });
  var btn=document.getElementById('tsmsMoreBtn');
  var bg=document.getElementById('tsmsMoreBg');
  var sheet=document.getElementById('tsmsMoreSheet');
  function closeMore(){sheet.classList.remove('show');bg.classList.remove('show');}
  if(btn&&bg&&sheet){
    btn.addEventListener('click',function(){sheet.classList.add('show');bg.classList.add('show');});
    bg.addEventListener('click',closeMore);
  }
  var guard = page==='report';
  function isDirtyReport(){
    var cash=document.getElementById('in_cash');
    var credit=document.getElementById('in_credit');
    var note=document.getElementById('in_note');
    var hasVal=((cash&&cash.value)||(credit&&credit.value)||(note&&note.value));
    var selected=document.querySelector('button[data-group].is-selected');
    return !!(hasVal||selected);
  }
  document.querySelectorAll('.tsms-bottom-nav a, .tsms-more-sheet a').forEach(function(a){
    a.addEventListener('click',function(e){
      if(guard && isDirtyReport() && !confirm('å…¥åŠ›ã‚’ä¸­æ­¢ã—ã¾ã™ã‹ï¼Ÿ')){
        e.preventDefault();
      }
      closeMore();
    });
  });
})();
</script>

</body>
</html>
