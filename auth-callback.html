<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>認証コールバック</title>
  <style>
    :root{ --bg:#F3F6F8; --surface-1:#FFFFFF; --surface-2:#EEF3F6; --border:#D5DEE6; --text-primary:#0F1720; --text-muted:#5B6D7C; --accent:#2580ED; }
    :root[data-theme="dark"]{ --bg:#0F1417; --surface-1:#151C20; --surface-2:#1B242A; --border:#2A353D; --text-primary:#E6EEF3; --text-muted:#8A949A; --accent:#3B95F0; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text-primary);font-family:"Noto Sans JP",sans-serif;}
    .header{position:sticky;top:0;height:60px;display:flex;align-items:center;padding:0 14px;border-bottom:2px solid var(--border);background:var(--surface-1);font-weight:900;font-size:20px;}
    .main{max-width:720px;margin:0 auto;padding:12px;}
    .section{border:2px solid var(--border);background:var(--surface-1);padding:12px;margin-top:10px;}
    .title{font-size:16px;font-weight:900;margin:0 0 8px;}
    .note{font-size:12px;color:var(--text-muted);line-height:1.45;}
    .status{margin-top:10px;border:2px solid var(--border);background:var(--surface-2);padding:10px;white-space:pre-wrap;}
    .actions{display:flex;gap:8px;margin-top:12px;}
    .btn{appearance:none;border:2px solid var(--border);background:var(--surface-2);padding:12px 10px;font-size:14px;font-weight:900;color:var(--text-primary);text-decoration:none;display:inline-flex;align-items:center;justify-content:center;}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
  </style>
  <meta name="theme-color" content="#ffffff">
  <script>(function(){try{var t=localStorage.getItem("tsms_theme")==="dark"?"dark":"light";document.documentElement.setAttribute("data-theme",t);var m=document.querySelector('meta[name="theme-color"]');if(m)m.setAttribute("content",t==="dark"?"#0F1417":"#F3F6F8");}catch(e){}})();</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="header">認証コールバック</header>
<main class="main">
  <section class="section">
    <div class="title">メールリンク確認中</div>
    <div class="note">認証メールのリンクから戻ってきた際の受け口ページです。完了後にログインページへ戻ってください。</div>
    <div class="status" id="status">処理中...</div>
    <div class="actions">
      <a class="btn" href="index.html">TOPへ</a>
      <a class="btn primary" href="login.html">ログインページへ</a>
    </div>
  </section>
</main>

<script>
(async function(){
  const statusEl = document.getElementById("status");
  function setStatus(text){ statusEl.textContent = text; }

  const CONFIG_KEY = "tsms_supabase_config";
  const FALLBACK_URL = "https://gsvehqeywmjqlvuzwvuo.supabase.co";
  const FALLBACK_ANON_KEY = "sb_publishable_PCpsmoo77V5L0YQfT2yKnA_QCEFpARJ";

  function readConfig(){
    try{
      const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY) || "null") || {};
      return {
        url: String(cfg.url || "").trim() || FALLBACK_URL,
        anonKey: String(cfg.anonKey || "").trim() || FALLBACK_ANON_KEY
      };
    }catch(_){
      return { url: FALLBACK_URL, anonKey: FALLBACK_ANON_KEY };
    }
  }

  const cfg = readConfig();
  if(!window.supabase || !window.supabase.createClient){
    setStatus("Supabase SDKの読み込みに失敗しました。");
    return;
  }
  if(!cfg.url || !cfg.anonKey){
    setStatus("Supabase設定が未完了です。settings.html で URL / Anon Key を設定してください。");
    return;
  }

  const supabase = window.supabase.createClient(cfg.url, cfg.anonKey);

  try{
    const url = new URL(location.href);
    const hasCode = !!url.searchParams.get("code");

    if(hasCode){
      const { error } = await supabase.auth.exchangeCodeForSession(location.href);
      if(error) throw error;
    }else if(location.hash.includes("access_token=")){
      const hash = new URLSearchParams(location.hash.replace(/^#/, ""));
      const access_token = hash.get("access_token");
      const refresh_token = hash.get("refresh_token");
      if(access_token && refresh_token){
        const { error } = await supabase.auth.setSession({ access_token, refresh_token });
        if(error) throw error;
      }
    }

    const { data, error } = await supabase.auth.getSession();
    if(error) throw error;
    if(data.session){
      setStatus("認証完了\nログイン中: " + data.session.user.email + "\nこのままログインページまたはTOPへ戻れます。");
    }else{
      setStatus("認証リンクは処理されましたが、セッションを確認できませんでした。\nもう一度ログインをお試しください。");
    }
  }catch(err){
    setStatus("認証処理に失敗しました:\n" + (err && err.message ? err.message : String(err)));
  }
})();
</script>
</body>
</html>
